{% extends "base.html" %}
{% block title %}Management Console - {{ block.super }}{% endblock %}
{% block body_classes %}home {{ block.super }}{% endblock body_classes %}
{% block breadcrumb %}<a href="#">Back to Something</a>{% endblock breadcrumb %}
{% block navtab %}{% include "partials/navtab-widget.html" with active="users" %}{% endblock navtab %}
<div class="modal-wrapper"><!-- ADD TO PARTIALS -->
<div class="widget-add-user" style="display:none">
    <form action="{% url 'blue_mgnt:users' %}" enctype="multipart/form-data" method="POST">
    {% for field in new_user.visible_fields %}
        <td>
            {{ field.label_tag }}
            {{ field }}
        {% if field.errors %}
            <br />
            <span class="errors">
            {% for error in field.errors %}
                {{ error }}
            {% endfor %}
            </span>
        </td>
        {% else %}
        </td>
        {% endif %}
    
    {% endfor %}
    <td>
        <input type="submit" value="Submit" class="button button-primary">
    </td>
    </form>
</div>
</div>
{% block content %}
<h1 class="page-header">
	<i class="ss-icon">&#x1F464;</i> Users
    <div class="actions">
		<button id="add-user" class="button button-primary">Add user</button>
        <form action="{% url 'blue_mgnt:users' %}" method="GET">
            <input name="show_disabled" type="hidden" value="{{ show_disabled }}">
            <input type="text" class="widget-search-input" value="{{ search }}" placeholder="Find Users by Name or Email">
            <input type="submit" class="search-button ss-icon" value="&#x1F50E;">
        </form>
	</div>
</h1>
<form action="{% url 'blue_mgnt:users' %}" method="POST" action="">
    {{ users.management_form }}
    {{ delete_user_formset.management_form }}
    {{ tmp_users_formset.management_form }}
<table class="widget-table">
	<thead>
		<th>
			Full Name
		</th>
		<th>
			Email
		</th>
		<th>
			Group
		</th>
		<th>
			Storage Size
		</th>
		<th>
			User Detail
		</th>
		<th>
			Delete?
            <input id="sel_all" type="checkbox">
		</th>
	</thead>
	<tbody>
    {% for curr_user in all_users %}
        <tr>
            {% for hidden in delete_user_formset.count0.hidden_fields %}
                {{ hidden }}
            {% endfor %}

            {% if not features.email_as_username %}
                <td>{{ curr_user.username}}</td>
            {% endif %}

            {% if curr_user.is_local_user %}
                {% for hidden in tmp_user_formset.local_index.hidden_fields %}
                    {{ hidden }}
                {% endfor %}

                {% for field in tmp_user_formset.local_index.visible_fields %}
                    <td>{{ field }}
                    {% if field.errors %}
                        <br />
                        <span class="table_errors">
                            {% for error in field.errors %}
                                {{ error }}
                            {% endfor %}
                        </span>
                    {% endif %} 
                {% endfor %}
            {% else %}
            <td>{{ curr_user.name }}</td>
            <td>{{ curr_user.email }}</td>
            <td>{{ curr_user.group_name }}</td>
            <td>{{ curr_user.gigs_stored }}</td>
            <td>
                <a href="{% url 'blue_mgnt:user_detail' curr_user.email %}">Detail</a>
            </td>
            <td>
                {% if not curr_user.enabled or curr_user.is_local_user and user.has_perm.blue_mgnt.can_manage_users %}
                    <span class="del_box">{{ delete_user_formset.count0 }}</span>
                {% endif %}
                <!-- TEST (Show the fromset no matter what) -->
                <span class="del_box">{{ delete_user_formset.count0 }}</span>
            </td>
        </tr>
                {% if curr_user.is_local_user %}
                    {{ local_index|add:"1" }}
                {% endif %}
            {% endif %}
            {% empty %}
                <p>Nothing to show</p>
            {% endfor %}
	</tbody>
</table>

<div class="widget-pagination">
	<ul>
		<li class="active">1</li>
		<li>2</li>
		<li>3</li>
		<li>4</li>
		<li>5</li>
	</ul>
</div>

<div class="widget-splitactions">
	<div class="rhs">
		<button class="button button-primary">Save Changes</button>
	</div>
	<div class="lhs">
		<button class="button button-muted">Hide Disabled Users</button>
		<button class="button button-muted">Download CSV</button>
	</div>
</div>

<div class="spacer"><!--ZXP--></div>

{% endblock content %}
